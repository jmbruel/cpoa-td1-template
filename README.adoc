= Design Patterns - TD 1
J.-M. Bruel <jbruel@gmail.com>
v20.1 {localdate}
:imagesdir: images
//------------------------- variables de configuration
// only used when master document
:icons: font
:experimental:
:numbered!:
:status:
:baseURL: https://github.com/LP-APSIO/MobileModeling2020
:github: https://github.com[GitHub]
// Specific to GitHub
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
//------------------------------------ 
ifdef::uk[]
:lastName: LAST NAME
:firstName: First Name
:group: Group
:example: Example
:Enseignants: Teachers
:principe: Good design principle
:assignment: Assignment info
:requirements: Requirements
:initial: Initial tasks
endif::[]
ifndef::uk[]
:lastName: NOM
:firstName: Prénom
:group: Groupe
:example: Exemple
:Enseignants: Enseignants
:principe: Principe Objet
:assignment: Informations générales
:requirements: Pré-requis
:initial: Tâche initiale
endif::[]
//------------------------------------ 

ifdef::uk[]
endif::[]
ifndef::uk[]
endif::[]


ifdef::uk[]
TD1 initial code.
This is a template for the students' assignments.
endif::[]
ifndef::uk[]
endif::[]

//------------------------------------ 
== {assignment}

{lastName}:: Doe

{firstName}:: John

{group} #::

[%interactive]
- [ ] {Enseignants}
- [x] 1
- [ ] 2
- [ ] 3
- [ ] 4
- [ ] Innopolis

//------------------------------------ 
== {requirements}

ifdef::uk[]
You'll need:

[%interactive]
* [x] A {Github} account  
* [ ] A https://gitforwindows.org/[Git Bash] terminal (if you use Window$)
endif::[]
ifndef::uk[]
Il vous faut :

[%interactive]
* [x] Un compte {Github}  
* [ ] Un terminal de type https://gitforwindows.org/[Git Bash]  (si vous utilisez Window$)
endif::[]

ifdef::uk[]
[TIP]
====    
Try the following command in your terminal to check your `git` environment:
endif::[]
ifndef::uk[]
[TIP]
====    
Essayez la commande suivante dans votre terminal pour vérifier votre environnement `git` :
endif::[]

[source,shell]
....
git config --global -l
....
====

//------------------------------------ 
== {initial}

ifdef::uk[]
[%interactive]
* [x] Click on the Github Classroom link provided by your teacher (in fact, this should be done if you read this).
* [ ] Clone on your machine the Github project generated by Github Classroom.  
* [ ] Modify the README file to add your last name, first name and group number. 
* [ ] Commit and push using the following message:
endif::[]
ifndef::uk[]
[%interactive]
* [x] Clickez sur le lien Github Classroom fourni par votre enseignant (en fait c'est déjà fait si vous lisez ces lignes).
* [ ] Clonez sur votre machine le projet Github généré pour vous par Github Classroom.  
* [ ] Modifez le `README` pour modifier Nom, Prénom et Groupe. 
* [ ] Commit & push:
endif::[]

.pass:[<i class="fa fa-github"></i>] commit/push
[source,shell]
....
fix #0 Initial task done
....

[IMPORTANT]
ifndef::uk[]
Dans la suite de ce document, à chaque fois que vous trouverez un énoncé commençant par `fix #...` vous devez vérifier que vos scripts/fichiers modifiés sont bien dans votre dépôt local en vue de committer et de pusher les modifications sur votre dépôt distant en utilisant comme message de commit cet énoncé.

[TIP]
====
- Si vous voulez vérifier que vous êtes prêt pour le `fix #0`, utilisez la commande : `make check`.
- Si vous voulez avoir la liste des ToDos de ce TP/TP, exécutez `make todos`.
====
endif::[]
ifdef::uk[]
In the following, every time you'll see à `fix #...` text, 
make sure all your files are committed, and then push your modifications in the distant repo, making sure you used the corresponding message (`fix #...`) in one of the `commit` messages.

[TIP]
====
- If you want to check that you're really ready for `fix #0`, you can run the command in your shell: `make check`.
- If you want to list the ToDos of the day, run `make todos`.
====
endif::[]




:numbered:
ifdef::uk[]
//------------------------------------ 
== The "SuperCanard" application

[NOTE]
=====
This TD exercise is inspired from the excellent https://www.oreilly.com/library/view/head-first-design/0596007124/[book]: "Head First: Design Pattern.
Bert Bates, Eric Freeman, Elisabeth Freeman, Kathy Sierra. Editions O'Reilly. 2005."

image::headFirst.jpg[link="https://www.oreilly.com/library/view/head-first-design/0596007124/",width=40%]
=====

=== Existing application

You are asked to work on an existing app `SuperCanard` (duck, called _canard_ in French, simulation game) which model (sorry for the French) is provided in the following class diagram:

.Existing app model (plantUML source link:images/superCanard.plantuml[here])
image::superCanard.png[]

NOTE: Some other classes inherit from `Canard`.

Here is a code example:
endif::[]
ifndef::uk[]
== L'application SuperCanard

NOTE: Les exercices de ce TD sont tirés de l'excellent livre "Tête la première : Design Pattern".
Bert Bates, Eric Freeman, Elisabeth Freeman, Kathy Sierra. Editions O'Reilly. 2005.

=== Application existante

Soit l'application (un jeu de simulation de mare aux canards) `SuperCanard` dont le modèle est
décrit ci-dessous :

.Extrait d'une application existante (source plantUML link:images/superCanard.plantuml[ici])
image::superCanard.png[]

NOTE: De nombreuses autres classes héritent de `Canard`.

Voici un exemple de code :
endif::[]

.`Canard.java`
[source,java]
--------
abstract public class Canard {

	public void cancaner() {
		System.out.println("Je cancane comme un Canard!");
	}

	public void nager() {
		System.out.println("Je nage comme un Canard!");
	}

	abstract public void afficher();
}
--------

.`Colvert.java`
[source,java]
--------
public class Colvert extends Canard {

	public void afficher() {
		System.out.println("Je suis un Colvert");
	}

}
--------

ifdef::uk[]
To launch the tests on this code, try:

[source,shell]
----
mvn test
----

[NOTE]
====
The tests should fail, and your auto-grading, from your previous commit should not be full. 
Check your last commit on your repo:

.Access to your commit status
image::check.png[]

.Get details on failure
image::autograding.png[]
====
endif::[]
ifndef::uk[]
Pour exécuter les tests sur ce code, essayez:

[source,shell]
----
mvn test
----

[NOTE]
====
Le test doit échouer et vous pouvez vous en rendre compte en regardant le commit de votre dépôt:

.Accédez à votre _commit status_
image::check.png[]

.Obtenez les détails de la _failure_
image::autograding.png[]
====
endif::[]

//----------------------------- Question ------------------
//------ No UK/FR after this point !!!!! ------------------
//----------------------------- Question ------------------
.*TODO*:
[WARNING]
====
[%interactive]
* [ ] Consyruisez l'application en utilisant `maven`:
+
.pass:[<i class="fa fa-github"></i>] commit/push
[source,shell]
....
mvn install
....
+
* [ ] Réparez le test errroné (on purpose) pour le faire passer
* [ ] Quand tout est OK, push votre code :
+
.pass:[<i class="fa fa-github"></i>] commit/push
[source,shell]
....
fix #1.1 First (running) draft of SuperCanard
....
+
- [ ] Vérifiez de nouveau le statut du commit:
+
.Get details on success :-)
image::autogradingOK.png[width=80%]
====

IMPORTANT: Prenez du temps pour regardez les tests.

=== Modification/Amélioration

Votre hiérarchie vous demande maintenant d'améliorer l'application
pour être plus proche de la réalité.

Vous décidez d'ajouter une méthode `voler()` à vos canards :

.Nouvelle fonctionnalité
image::superCanard2-note.png[]

.Deuxième version de Canard.java
[source,java]
--------
abstract public class Canard {

	public void cancaner() {
		System.out.println("Je cancane comme un Canard!");
	}

	public void nager() {
		System.out.println("Je nage comme un Canard!");
	}

	abstract public void afficher();

	public void voler() {
		System.out.println("Je vole comme un Canard!");
	};
}
--------

=== Catastrophe!

La hiérarchie vous appelle en urgence : des canards en plastiques se mettent
à voler dans l'application! En plus, certains canards malades, qui ne devraient
pas voler, volent!

TIP: Vous avez oublié que certains canards ne volaient pas!

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
Complétez la phrase suivante : L'*héritage* c'est super pour faire
de la ............. mais c'est plus problématique pour les aspects .............
====

=== Solution 1 : redéfinition de méthodes

Vous songez à une première solution simple : redéfinir la méthode `voler()` dans les canards qui ne volent pas.

//----------------------------- Question ------------------
.*TODO*:
[WARNING]
====
[%interactive]
- [ ] Ajoutez un (failing) test qui vérifie que les `CanardEnPlastique` ne volent pas.
- [ ] Faite passer le test en modifiant `CanardEnPlastique`. 
- [ ] Commit & Push: 
+
.pass:[<i class="fa fa-github"></i>] commit/push
[source,shell]
....
fix #1.4 Fixing the non-flying ducks
....
====

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
Dans la liste ci-après, quels sont les inconvénients à utiliser l’héritage pour
définir le comportement de `Canard` ? (Plusieurs choix possibles.) :

[options=interactive]
- [ ] Le même code est dupliqué (réécrit) entre les sous-classes.
- [ ] Les changements de méthodes de comportements au moment de l'exécution sont difficiles.
- [ ] Nous ne pouvons pas avoir de canards qui dansent.
- [ ] Il est difficile de connaître tous les comportements des canards
- [ ] Les canards ne peuvent pas voler et cancaner en même temps.
- [ ] Les modifications peuvent affecter involontairement d'autres canards.
====



=== Solution 2 : utilisation des interfaces

Vous songez à utiliser les interfaces pour améliorer le code.

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. Sur le diagramme suivant indiquez les relations d'héritage (`extends` de java)
et d'implémentation (`implements` de java) :
+
.Modèle de l'application existante (source plantUML  link:images/superCanardInterfaces.plantuml[ici])
image::superCanardInterfaces.png[]
+
. Que pensez-vous de la conception obtenue ?
====

=== Solution 3 : isoler ce qui varie

Vous êtes confrontés au même problème que dans le module `MPA` de ce début
d'année : *LE CHANGEMENT*!

Nous allons donc appliquer un bon {principe} :

[NOTE]
.{principe}
====
Identifiez les aspects de votre code qui varient et
séparez-les de ceux qui demeurent constants.
====

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
Quels sont les deux principales choses qui varient dans votre code?
====

==== Implémentation des comportements

Commençons par implémenter les comportements de manière séparée.
Pour cela nous rappelons un bon principe que vous avez déjà utilisé :

[NOTE]
.{principe}
====
Programmer une interface, non une implémentation.
====

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
En appliquant le principe ci-dessus, proposez une conception (diagramme de classe uniquement)
avec les classes et/ou interfaces (à vous de juger) suivantes : `ComportementVol`,
`VolerAvecDesAiles`, `NePasVoler`.
====

==== Intégration du comportement

Il nous faut maintenant relier les classes de canards à leur comportement.

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. Ajouter à la classe `Canard` deux attributs pour référencer les comportements.
. Enlevez les méthodes devenues inutiles.
. Remplacez-les (donnez les implémentations) par les méthodes
`effectuerVol()` et `effectuerCancan()` (qui utilisent les attributs précédents).
. Modifiez les constructeurs de `Colvert` (par exemple) pour indiquer
comment vos attributs sont initialisés.
// from André 2016 :
. Ajouter à la classe `Colvert` la méthode `setMalade()` et `setGueri()`
qui permettent au run-time de modifier le comportement de vol.
====

.pass:[<i class="fa fa-github"></i>] commit/push
[source,shell]
....
fix #1.6 Implementing outside behavior
....

====

==== Résumé et mise en oeuvre

Il est temps maintenant de prendre du recul et d'expérimenter les
avantages de notre nouvelle conception.

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. Réalisez le diagramme de classe complet de l'application.
. Que feriez-vous pour ajouter la propulsion à réaction à l'application?
. Voyez-vous une classe qui pourrait utiliser le comportement de `Cancan`
et qui n'est pas un `Canard`?
====
//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
[CAUTION]
.Solution
====
. Réalisez le diagramme de classe complet de l'application.
+
image::superCanardFinal.png[link="images/superCanardFinal.png"]
+
. Que feriez-vous pour ajouter la propulsion à réaction à l'application?
+
Tout simplement créer une classe `VolAReaction` qui implémente l'interface
`ComportementVol`.
+
. Voyez-vous une classe qui pourrait utiliser le comportement de `Cancan`
et qui n'est pas un `Canard`?
+
Par exemple un appeau!
====
endif::prof[]
//----------------------------------------------------- fin Correction -------------------------

=== Votre premier _Design Pattern_

==== La pattern Stratégie

En fait vous venez de mettre en oeuvre votre premier _Design Pattern_ :
le patron _Strategy_ (*Stratégie* en français).

[NOTE]
.Design pattern : *Stratégie* (_Strategy_)
====
include::pattern/strategy.txt[]
====

.Quelques exemples de description du patron _Strategy_
image::google-strategy.png[link="images/google-strategy.png"]

==== Mise en oeuvre et révision

//----------------------------- Question ------------------
[WARNING]
====
On vous demande de reprendre un jeu d'aventure dont
seul le modèle ci-dessous est fourni.

image::aventure-sujet.png[link="images/aventure-sujet.png"]

. Réorganiser les classes
. Identifier les classes abstraites, les interfaces et les classes ordinaires.
. Tracer les liens entre les classes ("est un", implémentation, "a un")
. Placer la méthode `setArme()` ci-dessous :
+
[source,java]
-----
setArme(ComportementArme a) {
  this.arme = a;
}
-----
====

====
.pass:[<i class="fa fa-github"></i>] commit/push
[source,shell]
....
fix #1.7 Adventure game
....
====


//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
[CAUTION]
.Solution
====
image::aventure.png[link="images/aventure.png"]
====

Certains étudiants font même du zèle quand ils sont motivés :

.Le modèle de Sylvain Frappez (2015)
image::TD1-frappez.png[link="images/TD1-frappez.png"]

endif::prof[]
//----------------------------------------------------- fin Correction -------------------------

:numbered!:
== {allerPlusLoin}


Nous avons utilisé sans le nommer un troisième bon principe :

[NOTE]
.{principe}
====
Préférez la composition à l'héritage.
====

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
Quelle différence entre notre conception finale
et une implémentation du type :

[source,java]
-----
abstract public class Canard implements ComportementVol {...}
-----






//------------------------------------ 
== Contributors
//------------------------------------ 

- mailto:jbruel@gmail.com[Jean-Michel Bruel]
